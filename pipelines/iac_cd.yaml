# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
parameters:
  - name: location
    type: string
    displayName: 'Azure Region'
    default: 'Australia East'
    values:
      - 'Australia East'
      - 'Australia SouthEast'
  - name: solutionName
    type: string
    displayName: 'Solution Name'
    default: 'azureiac'

trigger:
- main

stages:
- stage: Download_Artifact
  jobs:
  - job:
    steps:
    - task: DownloadBuildArtifacts@0
      displayName: 'Download compiled ARM template'
      inputs:
        buildType: 'specific'
        project: 'FTA'
        # this PipelineId will need to be updated based on the ID of your CI pipeline. This wouldnt be a problem if you use a single Build & Deploy YAML pipeline...
        pipeline: '72'
        specificBuildWithTriggering: true
        buildVersionToDownload: 'latest'
        downloadType: 'specific'
        downloadPath: '$(System.ArtifactsDirectory)'

- template: templates/iac_release.yaml
  parameters:
    location: '${{ parameters.location }}'
    environment: 'dev'
    name: '${{ parameters.solutionName }}'

- template: templates/iac_release.yaml
  parameters:
    location: '${{ parameters.location }}'
    environment: 'test'
    name: '${{ parameters.solutionName }}'
    
- template: templates/iac_release.yaml
  parameters:
    location: '${{ parameters.location }}'
    environment: 'prod'
    name: '${{ parameters.solutionName }}'

